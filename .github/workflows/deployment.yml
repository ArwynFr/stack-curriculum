name: deployment

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  deployment:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ”“ Docker login
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: ðŸ”¨ Git checkout
        uses: actions/checkout@v6

      - name: ðŸ”¨ Version number
        run: ./build/version/New-ReleaseVersion.ps1
        shell: pwsh
        id: version
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: ðŸ”¨ CA certificate
        run: echo '${{ secrets.authority }}' > ca.crt

      - name: ðŸ“¦ Build Docker image
        run: docker build ./src --tag 'ghcr.io/arwynfr/stack-curriculum:${{ steps.version.outputs.version }}'

      - name: ðŸ“¦ Package Helm chart
        run: helm package ./build/helm --version ${{ steps.version.outputs.version }}

      - name: ðŸ“Œ Push Docker image
        run: docker push 'ghcr.io/arwynfr/stack-curriculum:${{ steps.version.outputs.version }}'

      - name: ðŸ“Œ Push Helm chart
        run: helm push 'stack-curriculum-helm-${{ steps.version.outputs.version }}.tgz' 'oci://ghcr.io/arwynfr/stack-curriculum-helm:${{ steps.version.outputs.version }}'

      - name: ðŸš€ Upgrade Helm chart
        run: >
          helm upgrade stack-curriculum oci://ghcr.io/arwynfr/stack-curriculum-helm --install --force
          --version ${{ steps.version.outputs.version }}
          --kube-apiserver ${{ secrets.server }}
          --kube-token ${{ secrets.token }}
          --kube-ca-file ca.crt
          --set htpasswd=${{ secrets.htpasswd }}
          --namespace ${{ secrets.namespace }}

      - name: ðŸ“£ Create GH release
        shell: pwsh
        run: gh release create ${{ steps.version.outputs.version }} --generate-notes
        env:
          GH_TOKEN: ${{ github.token }}
